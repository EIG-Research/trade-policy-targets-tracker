filter(year == 2000) %>% summarise(y = mean(manufacturing))
y_lvl = as.numeric(y_lvl[1,1])
plot_ly(
data = manu_df,
x = ~quarter,
y = ~manufacturing,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}M<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Quarterly)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Millions of Workers)",
tickformat = "$,.1f",
ticksuffix = ""),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.27,
y = y_lvl + 0.2,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"M"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
manu_share_df = tibble(
quarter = as.Date(as.yearqtr(time(manu_share))),
manufacturing_share = as.numeric(manu_share) *100,
hover_label = format(as.yearqtr(quarter), "%Y Q%q")
)
# Dynamically generate tick dates: Q1 every 5 years
date_range <- range(manu_share_df$quarter)
start_year <- lubridate::year(date_range[1])
end_year   <- lubridate::year(date_range[2])
# Round to the nearest lower multiple of 5
start_year <- start_year - (start_year %% 5)
end_year   <- end_year + (5 - end_year %% 5)
tick_years <- seq(start_year, end_year, by = 5)
tick_dates <- as.Date(paste0(tick_years, "-01-01"))  # Q1 of each year
tick_texts <- paste0("Q1 ", tick_years)
y_lvl = manu_share_df %>% mutate(year = lubridate::year(quarter)) %>%
filter(year == 2000) %>% summarise(y = mean(manufacturing_share))
y_lvl = as.numeric(y_lvl[1,1])
plot_ly(
data = manu_share_df,
x = ~quarter,
y = ~manufacturing_share,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}%<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Quarterly)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Share of Private-Sector Workers (%)",
tickformat = ".1f",
ticksuffix = "%"),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.26,
y = y_lvl + 0.3,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"%"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
china_shock_yr
time(china_shock_yr)
## Employment in manufacturing, counties most affected by the "China shock"  ##
china_shock_df <- tibble(year = time(china_shock_yr),
cs_manu_emp = as.numeric(china_shock_yr),
hover_label = as.character(year))
View(china_shock_df)
# Dynamically generate tick dates: Q1 every 5 years
start_year <- china_shock_df$year[1]
end_year   <- china_shock_df$year[nrow(china_shock_df)]
start_year
end_year
start_year <- start_year - (start_year %% 5)
end_year   <- end_year + (5 - end_year %% 5)
start_year
end_year
# Dynamically generate tick dates: Q1 every 5 years
start_year <- china_shock_df$year[1]
end_year   <- china_shock_df$year[nrow(china_shock_df)]
# Round to the nearest lower multiple of 5
start_year <- start_year - (start_year %% 5)
end_year   <- end_year + (5 - end_year %% 5)
tick_years <- seq(start_year, end_year, by = 5)
tick_dates <- as.Date(paste0(tick_years, "-01-01"))  # Q1 of each year
tick_texts <- as.character(tick_years)
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: {y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".1f",
ticksuffix = "M"),
hovermode = "closest")
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".1f",
ticksuffix = "M"),
hovermode = "closest")
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".1f",
ticksuffix = "K")
plot_ly(
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".1f",
ticksuffix = ""),
hovermode = "closest")
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_dates,
ticktext = tick_texts,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = "K"),
hovermode = "closest")
tick_dates
as.character(tick_years)
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_dates,
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest")
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
hoverformat = "%Y Q%q",
range = c(tick_dates[1], tick_dates[length(tick_dates)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest")
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_years,
hoverformat = "%Y Q%q",
range = c(tick_years[1], tick_years[length(tick_years)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest")
y_lvl = china_shock_df %>% filter(year == 2000) %>% .$cs_manu_emp
y_lvl <- china_shock_df %>% filter(year == 2000) %>% .$cs_manu_emp
y_lvl
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_years,
hoverformat = "%Y Q%q",
range = c(tick_years[1], tick_years[length(tick_years)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.26,
y = y_lvl + 0.3,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"%"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_years,
hoverformat = "%Y Q%q",
range = c(tick_years[1], tick_years[length(tick_years)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.3,
y = y_lvl + 1,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"%"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_years,
hoverformat = "%Y Q%q",
range = c(tick_years[1], tick_years[length(tick_years)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.28,
y = y_lvl + 5,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"%"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_years,
hoverformat = "%Y Q%q",
range = c(tick_years[1], tick_years[length(tick_years)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.28,
y = y_lvl + 10,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"%"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
plot_ly(
data = china_shock_df,
x = ~year,
y = ~cs_manu_emp,
type = 'scatter',
mode = 'lines',
line = list(color = eig_colors[1], width = 2),
text = ~hover_label,
hovertemplate = "%{x}: %{y:,.1f}K<extra></extra>"
) %>%
layout(
xaxis = list(title = "Time (Annual)",
tickvals = tick_years,
hoverformat = "%Y Q%q",
range = c(tick_years[1], tick_years[length(tick_years)])),
yaxis = list(title = "Employment (Thousands of Workers)",
tickformat = ".0f",
ticksuffix = ""),
hovermode = "closest",
# add target line
shapes = list(
list(
type = "line",
xref = "paper",
x0 = 0, x1 = 1,
y0 = y_lvl, y1 = y_lvl,
line = list(color = eig_colors[1], width = 2, dash = "dash")
)
),
# add label for target
annotations = list(
list(
xref = "paper",
x = 0.28,
y = y_lvl + 8,
text = paste0("2000 level, before China joined the WTO = " , round(y_lvl, 1),"%"),
showarrow = FALSE,
font = list(color = eig_colors[2], size = 12),
xanchor = "left",
yanchor = "middle"
)
)
)
runApp('plotly app experiment.R')
runApp('plotly app experiment.R')
library(shiny); runApp('plotly app experiment.R')
